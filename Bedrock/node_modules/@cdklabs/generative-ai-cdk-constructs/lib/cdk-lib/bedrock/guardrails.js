"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Guardrail = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const fs = require("fs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const kms = require("aws-cdk-lib/aws-kms");
const constructs_1 = require("constructs");
const content_policy_1 = require("./content-policy");
const guardrail_version_1 = require("./guardrail-version");
const pii_list_1 = require("./pii-list");
const utils_1 = require("../../common/helpers/utils");
/**
 * Deploy bedrock guardrail .
 */
class Guardrail extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.name = props.name ?? (0, utils_1.generatePhysicalNameV2)(this, 'bedrock-guardrail', { maxLength: 32, lower: true, separator: '-' });
        this.kmsKeyArn = props.kmsKeyArn ?? new kms.Key(scope, `'${id}Key'`, {
            enableKeyRotation: true,
        }).keyArn;
        const defaultBlockedInputMessaging = 'Sorry, your query voilates our usage policy.';
        const defaultBlockedOutputsMessaging = 'Sorry, I am unable to answer your question because of our usage policy.';
        this.guardrailInstance = new aws_cdk_lib_1.aws_bedrock.CfnGuardrail(this, 'MyGuardrail', {
            blockedInputMessaging: props.blockedInputMessaging ?? defaultBlockedInputMessaging,
            blockedOutputsMessaging: props.blockedOutputsMessaging ?? defaultBlockedOutputsMessaging,
            name: this.name,
            description: props.description,
            kmsKeyArn: this.kmsKeyArn,
            contentPolicyConfig: {
                filtersConfig: new content_policy_1.ContentPolicyConfig(this, `'CP${id}'`, props.filtersConfig).contentPolicyConfigList,
            },
        });
        if (props.contextualGroundingfiltersConfig) {
            this.guardrailInstance.contextualGroundingPolicyConfig = {
                filtersConfig: props.contextualGroundingfiltersConfig.map((prop) => ({
                    type: prop.filtersConfigType,
                    threshold: prop.threshold,
                })),
            };
        }
        this.guardrailVersion = this.guardrailInstance.attrVersion;
        this.guardrailId = this.guardrailInstance.attrGuardrailId;
    }
    addSensitiveInformationPolicyConfig(props, guardrailRegexesConfig) {
        if (props) {
            this.guardrailInstance.sensitiveInformationPolicyConfig =
                {
                    piiEntitiesConfig: new pii_list_1.SensitiveInformationPolicyConfig(this, 'PII', props).piiConfigList,
                    regexesConfig: [guardrailRegexesConfig],
                };
        }
        else {
            throw new Error('No guardrailPiiEntityConfig or guardrailRegexesConfig is set in GuardrailProps.');
        }
    }
    addContextualGroundingPolicyConfig(props) {
        if (props) {
            this.guardrailInstance.contextualGroundingPolicyConfig = {
                filtersConfig: props.map((prop) => ({
                    type: prop.filtersConfigType,
                    threshold: prop.threshold,
                })),
            };
        }
        else {
            throw new Error('No ContextualGroundingPolicyConfig is set in GuardrailProps.');
        }
    }
    async uploadWordPolicyFromFile(filePath) {
        try {
            const wordsFilter = [];
            // Read the file line by line and extract the words
            const fileContents = await fs.promises.readFile(filePath, 'utf8');
            const lines = fileContents.trim().split(',');
            for (const line of lines) {
                const word = line.trim();
                if (word) {
                    wordsFilter.push({ text: word });
                }
            }
            // Add the word policy configuration
            this.addWordPolicyConfig(wordsFilter);
        }
        catch (error) {
            console.error('Error reading file and adding word policy config:', error);
            throw error;
        }
    }
    addWordPolicyConfig(wordsFilter) {
        if (wordsFilter && wordsFilter.length > 0) {
            this.guardrailInstance.wordPolicyConfig =
                {
                    managedWordListsConfig: [{
                            type: 'PROFANITY',
                        }],
                    wordsConfig: wordsFilter,
                };
        }
        else {
            throw new Error('props.wordsFilter is empty or undefined in GuardrailProps.');
        }
    }
    addTopicPolicyConfig(topic) {
        if (topic) {
            this.guardrailInstance.topicPolicyConfig =
                {
                    topicsConfig: topic.topicConfigPropertyList(),
                };
        }
        else {
            throw new Error('topic.topicConfigPropertylist is empty or undefined in GuardrailProps.');
        }
    }
    addTags(props) {
        if (props && props.tags) {
            this.guardrailInstance.tags = props.tags;
        }
    }
    /**
     * Creates a version of the guardrail.
     */
    addVersion(id, description) {
        const version = new guardrail_version_1.GuardrailVersion(this, id, {
            guardrailIdentifier: this.guardrailId,
            description,
        });
        return version;
    }
}
exports.Guardrail = Guardrail;
_a = JSII_RTTI_SYMBOL_1;
Guardrail[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.Guardrail", version: "0.1.264" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3VhcmRyYWlscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jZGstbGliL2JlZHJvY2svZ3VhcmRyYWlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBR0gseUJBQXlCO0FBQ3pCLDZDQUE2RDtBQUM3RCwyQ0FBMkM7QUFDM0MsMkNBQXVDO0FBRXZDLHFEQUF1SDtBQUN2SCwyREFBdUQ7QUFDdkQseUNBQXFHO0FBRXJHLHNEQUFvRTtBQXFEcEU7O0dBRUc7QUFDSCxNQUFhLFNBQVUsU0FBUSxzQkFBUztJQWtDdEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFxQjtRQUM3RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFBLDhCQUFzQixFQUM5QyxJQUFJLEVBQ0osbUJBQW1CLEVBQ25CLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBRWxELElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsSUFBSSxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7WUFDbkUsaUJBQWlCLEVBQUUsSUFBSTtTQUN4QixDQUFDLENBQUMsTUFBTSxDQUFDO1FBRVYsTUFBTSw0QkFBNEIsR0FBRyw4Q0FBOEMsQ0FBQztRQUNwRixNQUFNLDhCQUE4QixHQUFHLHlFQUF5RSxDQUFDO1FBRWpILElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLHlCQUFPLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUU7WUFDckUscUJBQXFCLEVBQUUsS0FBSyxDQUFDLHFCQUFxQixJQUFJLDRCQUE0QjtZQUNsRix1QkFBdUIsRUFBRSxL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QVc7WUFDckMsV0FBVztTQUNaLENBQUMsQ0FBQztRQUNILE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7O0FBNUtILDhCQThLQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgQ2ZuVGFnLCBhd3NfYmVkcm9jayBhcyBiZWRyb2NrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMga21zIGZyb20gJ2F3cy1jZGstbGliL2F3cy1rbXMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbmltcG9ydCB7IENvbnRlbnRQb2xpY3lDb25maWcsIENvbnRlbnRQb2xpY3lDb25maWdQcm9wcywgQ29udGV4dHVhbEdyb3VuZGluZ1BvbGljeUNvbmZpZ1Byb3BzIH0gZnJvbSAnLi9jb250ZW50LXBvbGljeSc7XG5pbXBvcnQgeyBHdWFyZHJhaWxWZXJzaW9uIH0gZnJvbSAnLi9ndWFyZHJhaWwtdmVyc2lvbic7XG5pbXBvcnQgeyBTZW5zaXRpdmVJbmZvcm1hdGlvblBvbGljeUNvbmZpZywgU2Vuc2l0aXZlSW5mb3JtYXRpb25Qb2xpY3lDb25maWdQcm9wcyB9IGZyb20gJy4vcGlpLWxpc3QnO1xuaW1wb3J0IHsgVG9waWMgfSBmcm9tICcuL3RvcGljLWxpc3QnO1xuaW1wb3J0IHsgZ2VuZXJhdGVQaHlzaWNhbE5hbWVWMiB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL3V0aWxzJztcblxuXG4vKipcbiAqIEJlZHJvY2sgZ3VhcmRyYWlsIHByb3BzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgR3VhcmRyYWlsUHJvcHMge1xuICAvKipcbiAgICogVGhlIG1lc3NhZ2UgdG8gcmV0dXJuIHdoZW4gdGhlIGd1YXJkcmFpbCBibG9ja3MgYSBwcm9tcHQuXG4gICAqL1xuICByZWFkb25seSBibG9ja2VkSW5wdXRNZXNzYWdpbmc/IDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIG1lc3NhZ2UgdG8gcmV0dXJuIHdoZW4gdGhlIGd1YXJkcmFpbCBibG9ja3MgYSBtb2RlbCByZXNwb25zZS5cbiAgICovXG4gIHJlYWRvbmx5IGJsb2NrZWRPdXRwdXRzTWVzc2FnaW5nP1x0OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZ3VhcmRyYWlsLlxuICAgKi9cbiAgcmVhZG9ubHkgbmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICAqIExpc3Qgb2YgY29udGVudCBmaWx0ZXIgY29uZmlncyBpbiBjb250ZW50IHBvbGljeS5cbiAgICAqL1xuICByZWFkb25seSBmaWx0ZXJzQ29uZmlnPzogQ29udGVudFBvbGljeUNvbmZpZ1Byb3BzW107XG5cbiAgLyoqXG4gICAgKiBDb250ZXh0dWFsIGdyb3VuZGluZyBwb2xpY3kgY29uZmlnIGZvciBhIGd1YXJkcmFpbC5cbiAgICAqL1xuICByZWFkb25seSBjb250ZXh0dWFsR3JvdW5kaW5nZmlsdGVyc0NvbmZpZz86IENvbnRleHR1YWxHcm91bmRpbmdQb2xpY3lDb25maWdQcm9wc1tdO1xuXG4gIC8qKlxuICAgICogUElJIGZpZWxkcyB3aGljaCBuZWVkcyB0byBiZSBtYXNrZWQuXG4gICAgKi9cbiAgcmVhZG9ubHkgcGlpQ29uZmlnPzogU2Vuc2l0aXZlSW5mb3JtYXRpb25Qb2xpY3lDb25maWdQcm9wc1tdO1xuXG5cbiAgLyoqXG4gICAqIFRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgZ3VhcmRyYWlsLlxuICAgKi9cbiAgcmVhZG9ubHkgZGVzY3JpcHRpb24/XHQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgQVdTIEtNUyBrZXkgdXNlZCB0byBlbmNyeXB0IHRoZSBndWFyZHJhaWwuXG4gICAqL1xuICByZWFkb25seSBrbXNLZXlBcm4/XHQ6IHN0cmluZztcblxuICAvKipcbiAgICogTWV0YWRhdGEgdGhhdCB5b3UgY2FuIGFzc2lnbiB0byBhIGd1YXJkcmFpbCBhcyBrZXktdmFsdWUgcGFpcnNcbiAgICpcbiAgICovXG4gIHJlYWRvbmx5IHRhZ3M/OiBBcnJheTxDZm5UYWc+O1xufVxuXG4vKipcbiAqIERlcGxveSBiZWRyb2NrIGd1YXJkcmFpbCAuXG4gKi9cbmV4cG9ydCBjbGFzcyBHdWFyZHJhaWwgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZ3VhcmRyYWlsLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIEFSTiBvZiB0aGUgQVdTIEtNUyBrZXkgdXNlZCB0byBlbmNyeXB0IHRoZSBndWFyZHJhaWwuXG4gICAqXG4gICAqIEBkZWZhdWx0XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkga21zS2V5QXJuXHQ6IHN0cmluZztcblxuICAvKipcbiAgICogZ3VhcmRyYWlsIHZlcnNpb25cbiAgICpcbiAgICogQGRlZmF1bHRcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBndWFyZHJhaWxWZXJzaW9uXHQ6IHN0cmluZztcblxuICAvKipcbiAgICogZ3VhcmRyYWlsIElkXG4gICAqXG4gICAqIEBkZWZhdWx0XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZ3VhcmRyYWlsSWRcdDogc3RyaW5nO1xuXG5cbiAgLyoqXG4gICAqIEluc3RhbmNlIG9mIGd1YXJkcmFpbFxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGd1YXJkcmFpbEluc3RhbmNlOiBiZWRyb2NrLkNmbkd1YXJkcmFpbDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogR3VhcmRyYWlsUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5uYW1lID0gcHJvcHMubmFtZSA/PyBnZW5lcmF0ZVBoeXNpY2FsTmFtZVYyKFxuICAgICAgdGhpcyxcbiAgICAgICdiZWRyb2NrLWd1YXJkcmFpbCcsXG4gICAgICB7IG1heExlbmd0aDogMzIsIGxvd2VyOiB0cnVlLCBzZXBhcmF0b3I6ICctJyB9KTtcblxuICAgIHRoaXMua21zS2V5QXJuID0gcHJvcHMua21zS2V5QXJuID8/IG5ldyBrbXMuS2V5KHNjb3BlLCBgJyR7aWR9S2V5J2AsIHtcbiAgICAgIGVuYWJsZUtleVJvdGF0aW9uOiB0cnVlLFxuICAgIH0pLmtleUFybjtcblxuICAgIGNvbnN0IGRlZmF1bHRCbG9ja2VkSW5wdXRNZXNzYWdpbmcgPSAnU29ycnksIHlvdXIgcXVlcnkgdm9pbGF0ZXMgb3VyIHVzYWdlIHBvbGljeS4nO1xuICAgIGNvbnN0IGRlZmF1bHRCbG9ja2VkT3V0cHV0c01lc3NhZ2luZyA9ICdTb3JyeSwgSSBhbSB1bmFibGUgdG8gYW5zd2VyIHlvdXIgcXVlc3Rpb24gYmVjYXVzZSBvZiBvdXIgdXNhZ2UgcG9saWN5Lic7XG5cbiAgICB0aGlzLmd1YXJkcmFpbEluc3RhbmNlID0gbmV3IGJlZHJvY2suQ2ZuR3VhcmRyYWlsKHRoaXMsICdNeUd1YXJkcmFpbCcsIHtcbiAgICAgIGJsb2NrZWRJbnB1dE1lc3NhZ2luZzogcHJvcHMuYmxvY2tlZElucHV0TWVzc2FnaW5nID8/IGRlZmF1bHRCbG9ja2VkSW5wdXRNZXNzYWdpbmcsXG4gICAgICBibG9ja2VkT3V0cHV0c01lc3NhZ2luZzogcHJvcHMuYmxvY2tlZE91dHB1dHNNZXNzYWdpbmcgPz8gZGVmYXVsdEJsb2NrZWRPdXRwdXRzTWVzc2FnaW5nLFxuICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgZGVzY3JpcHRpb246IHByb3BzLmRlc2NyaXB0aW9uLFxuICAgICAga21zS2V5QXJuOiB0aGlzLmttc0tleUFybixcbiAgICAgIGNvbnRlbnRQb2xpY3lDb25maWc6IHtcbiAgICAgICAgZmlsdGVyc0NvbmZpZzogbmV3IENvbnRlbnRQb2xpY3lDb25maWcodGhpcywgYCdDUCR7aWR9J2AsIHByb3BzLmZpbHRlcnNDb25maWcpLmNvbnRlbnRQb2xpY3lDb25maWdMaXN0LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGlmIChwcm9wcy5jb250ZXh0dWFsR3JvdW5kaW5nZmlsdGVyc0NvbmZpZykge1xuICAgICAgdGhpcy5ndWFyZHJhaWxJbnN0YW5jZS5jb250ZXh0dWFsR3JvdW5kaW5nUG9saWN5Q29uZmlnID0ge1xuICAgICAgICBmaWx0ZXJzQ29uZmlnOlxuICAgICAgICAgIHByb3BzLmNvbnRleHR1YWxHcm91bmRpbmdmaWx0ZXJzQ29uZmlnLm1hcCgocHJvcCkgPT4gKHtcbiAgICAgICAgICAgIHR5cGU6IHByb3AuZmlsdGVyc0NvbmZpZ1R5cGUsXG4gICAgICAgICAgICB0aHJlc2hvbGQ6IHByb3AudGhyZXNob2xkLFxuICAgICAgICAgIH0pKSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdGhpcy5ndWFyZHJhaWxWZXJzaW9uID0gdGhpcy5ndWFyZHJhaWxJbnN0YW5jZS5hdHRyVmVyc2lvbjtcbiAgICB0aGlzLmd1YXJkcmFpbElkID0gdGhpcy5ndWFyZHJhaWxJbnN0YW5jZS5hdHRyR3VhcmRyYWlsSWQ7XG5cbiAgfVxuXG4gIHB1YmxpYyBhZGRTZW5zaXRpdmVJbmZvcm1hdGlvblBvbGljeUNvbmZpZyhcbiAgICBwcm9wczogU2Vuc2l0aXZlSW5mb3JtYXRpb25Qb2xpY3lDb25maWdQcm9wc1tdLFxuICAgIGd1YXJkcmFpbFJlZ2V4ZXNDb25maWcgOiBiZWRyb2NrLkNmbkd1YXJkcmFpbC5SZWdleENvbmZpZ1Byb3BlcnR5KSB7XG5cbiAgICBpZiAocHJvcHMpIHtcbiAgICAgIHRoaXMuZ3VhcmRyYWlsSW5zdGFuY2Uuc2Vuc2l0aXZlSW5mb3JtYXRpb25Qb2xpY3lDb25maWcgPVxuICAgIHtcbiAgICAgIHBpaUVudGl0aWVzQ29uZmlnOiBuZXcgU2Vuc2l0aXZlSW5mb3JtYXRpb25Qb2xpY3lDb25maWcodGhpcywgJ1BJSScsIHByb3BzKS5waWlDb25maWdMaXN0LFxuICAgICAgcmVnZXhlc0NvbmZpZzogW2d1YXJkcmFpbFJlZ2V4ZXNDb25maWddLFxuICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gZ3VhcmRyYWlsUGlpRW50aXR5Q29uZmlnIG9yIGd1YXJkcmFpbFJlZ2V4ZXNDb25maWcgaXMgc2V0IGluIEd1YXJkcmFpbFByb3BzLicpO1xuXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFkZENvbnRleHR1YWxHcm91bmRpbmdQb2xpY3lDb25maWcoIHByb3BzOiBDb250ZXh0dWFsR3JvdW5kaW5nUG9saWN5Q29uZmlnUHJvcHNbXSkge1xuICAgIGlmIChwcm9wcykge1xuICAgICAgdGhpcy5ndWFyZHJhaWxJbnN0YW5jZS5jb250ZXh0dWFsR3JvdW5kaW5nUG9saWN5Q29uZmlnID0ge1xuICAgICAgICBmaWx0ZXJzQ29uZmlnOlxuICAgICAgICAgIHByb3BzLm1hcCgocHJvcCkgPT4gKHtcbiAgICAgICAgICAgIHR5cGU6IHByb3AuZmlsdGVyc0NvbmZpZ1R5cGUsXG4gICAgICAgICAgICB0aHJlc2hvbGQ6IHByb3AudGhyZXNob2xkLFxuICAgICAgICAgIH0pKSxcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gQ29udGV4dHVhbEdyb3VuZGluZ1BvbGljeUNvbmZpZyBpcyBzZXQgaW4gR3VhcmRyYWlsUHJvcHMuJyk7XG4gICAgfVxuICB9XG5cblxuICBwdWJsaWMgYXN5bmMgdXBsb2FkV29yZFBvbGljeUZyb21GaWxlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgd29yZHNGaWx0ZXI6IGJlZHJvY2suQ2ZuR3VhcmRyYWlsLldvcmRDb25maWdQcm9wZXJ0eVtdID0gW107XG5cbiAgICAgIC8vIFJlYWQgdGhlIGZpbGUgbGluZSBieSBsaW5lIGFuZCBleHRyYWN0IHRoZSB3b3Jkc1xuICAgICAgY29uc3QgZmlsZUNvbnRlbnRzID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZmlsZVBhdGgsICd1dGY4Jyk7XG4gICAgICBjb25zdCBsaW5lcyA9IGZpbGVDb250ZW50cy50cmltKCkuc3BsaXQoJywnKTtcblxuICAgICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICAgIGNvbnN0IHdvcmQgPSBsaW5lLnRyaW0oKTtcbiAgICAgICAgaWYgKHdvcmQpIHtcbiAgICAgICAgICB3b3Jkc0ZpbHRlci5wdXNoKHsgdGV4dDogd29yZCB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBBZGQgdGhlIHdvcmQgcG9saWN5IGNvbmZpZ3VyYXRpb25cbiAgICAgIHRoaXMuYWRkV29yZFBvbGljeUNvbmZpZyh3b3Jkc0ZpbHRlcik7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHJlYWRpbmcgZmlsZSBhbmQgYWRkaW5nIHdvcmQgcG9saWN5IGNvbmZpZzonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuXG4gIHB1YmxpYyBhZGRXb3JkUG9saWN5Q29uZmlnKHdvcmRzRmlsdGVyPzogYmVkcm9jay5DZm5HdWFyZHJhaWwuV29yZENvbmZpZ1Byb3BlcnR5W10pIHtcbiAgICBpZiAod29yZHNGaWx0ZXIgJiYgd29yZHNGaWx0ZXIgLmxlbmd0aCA+IDAgKSB7XG4gICAgICB0aGlzLmd1YXJkcmFpbEluc3RhbmNlLndvcmRQb2xpY3lDb25maWcgPVxuICAgIHtcbiAgICAgIG1hbmFnZWRXb3JkTGlzdHNDb25maWc6IFt7XG4gICAgICAgIHR5cGU6ICdQUk9GQU5JVFknLFxuICAgICAgfV0sXG4gICAgICB3b3Jkc0NvbmZpZzogd29yZHNGaWx0ZXIsXG4gICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9wcy53b3Jkc0ZpbHRlciBpcyBlbXB0eSBvciB1bmRlZmluZWQgaW4gR3VhcmRyYWlsUHJvcHMuJyk7XG5cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYWRkVG9waWNQb2xpY3lDb25maWcodG9waWM6IFRvcGljKSB7XG4gICAgaWYgKHRvcGljICkge1xuICAgICAgdGhpcy5ndWFyZHJhaWxJbnN0YW5jZS50b3BpY1BvbGljeUNvbmZpZyA9XG4gICAge1xuICAgICAgdG9waWNzQ29uZmlnOiB0b3BpYy50b3BpY0NvbmZpZ1Byb3BlcnR5TGlzdCgpLFxuXG4gICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0b3BpYy50b3BpY0NvbmZpZ1Byb3BlcnR5bGlzdCBpcyBlbXB0eSBvciB1bmRlZmluZWQgaW4gR3VhcmRyYWlsUHJvcHMuJyk7XG5cbiAgICB9XG4gIH1cbiAgcHVibGljIGFkZFRhZ3MocHJvcHM6IEd1YXJkcmFpbFByb3BzKSB7XG4gICAgaWYgKHByb3BzICYmIHByb3BzLnRhZ3MpIHtcbiAgICAgIHRoaXMuZ3VhcmRyYWlsSW5zdGFuY2UudGFncyA9IHByb3BzLnRhZ3M7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSB2ZXJzaW9uIG9mIHRoZSBndWFyZHJhaWwuXG4gICAqL1xuICBwdWJsaWMgYWRkVmVyc2lvbihpZDogc3RyaW5nLCBkZXNjcmlwdGlvbj86IHN0cmluZyk6IEd1YXJkcmFpbFZlcnNpb24ge1xuICAgIGNvbnN0IHZlcnNpb24gPSBuZXcgR3VhcmRyYWlsVmVyc2lvbih0aGlzLCBpZCwge1xuICAgICAgZ3VhcmRyYWlsSWRlbnRpZmllcjogdGhpcy5ndWFyZHJhaWxJZCxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgIH0pO1xuICAgIHJldHVybiB2ZXJzaW9uO1xuICB9XG5cbn0iXX0=