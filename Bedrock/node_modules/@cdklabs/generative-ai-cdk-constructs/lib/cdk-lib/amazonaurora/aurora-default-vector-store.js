"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmazonAuroraDefaultVectorStore = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const path = require("path");
const cdk = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const iam = require("aws-cdk-lib/aws-iam");
const rds = require("aws-cdk-lib/aws-rds");
const cdk_nag_1 = require("cdk-nag");
const custom_resource_provider_helper_1 = require("../../common/helpers/custom-resource-provider-helper");
const utils_1 = require("../../common/helpers/utils");
const vpc_helper_1 = require("../../common/helpers/vpc-helper");
/**
  * Creates default AmazonAuroraVectorStore.
  *
  * It includes creation of a VPC with 3 subnets (public,
  * private with NAT Gateway, private without NAT Gateway),
  * with the Amazon Aurora Serverless V2 Cluster.
  * The cluster has 1 writer/reader of PostgreSQL version 15.5
  * instance (min capacity 0.5, max capacity 4). Lambda custom
  * resource executes required pgvector and Amazon Bedrock Knowledge
  * Base SQL queries against Aurora cluster
  * during deployment. The secret containing databases credentials is
  * being deployed and securely stored in AWS Secrets Manager.
  * You must specify the same embeddings model that you used in
  * KnowledgeBase construct.
  * @see https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.VectorDB.html)
  */
class AmazonAuroraDefaultVectorStore extends cdk.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        this.databaseName = 'bedrock_vector_db';
        this.tableName = 'bedrock_integration.bedrock_kb';
        this.primaryKeyField = 'id';
        this.clusterIdentifier = 'aurora-serverless-vector-cluster';
        this.embeddingsModelVectorDimension = props.embeddingsModelVectorDimension;
        this.vpc = (0, vpc_helper_1.buildVpc)(this, {
            defaultVpcProps: (0, vpc_helper_1.DefaultVpcProps)(),
            existingVpc: props.vpc,
        });
        this.vpc.addFlowLog('VpcFlowLog', {
            destination: ec2.FlowLogDestination.toCloudWatchLogs(),
        });
        this.auroraSecurityGroup = new ec2.SecurityGroup(this, 'AuroraSecurityGroup', {
            vpc: this.vpc,
            securityGroupName: 'aurora-security-group',
            description: 'Security group for access to Aurora from Lambda',
        });
        const lambdaSecurityGroup = new ec2.SecurityGroup(this, 'LambdaSecurityGroup', {
            vpc: this.vpc,
            securityGroupName: 'lambda-security-group',
            description: 'Security group for Lambda access to Aurora',
        });
        const auroraCluster = new rds.DatabaseCluster(this, 'AuroraCluster', {
            engine: rds.DatabaseClusterEngine.auroraPostgres({
                version: rds.AuroraPostgresEngineVersion.VER_15_5,
            }),
            credentials: rds.Credentials.fromGeneratedSecret('postgres'),
            clusterIdentifier: this.clusterIdentifier,
            defaultDatabaseName: this.databaseName,
            vpc: this.vpc,
            vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },
            securityGroups: [this.auroraSecurityGroup],
            iamAuthentication: true,
            storageEncrypted: true,
            serverlessV2MinCapacity: 0.5,
            serverlessV2MaxCapacity: 4,
            writer: rds.ClusterInstance.serverlessV2('AuroraServerlessWriter'),
            readers: [rds.ClusterInstance.serverlessV2('AuroraServerlessReader', { scaleWithWriter: true })],
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        this.credentialsSecretArn = auroraCluster.secret?.secretArn || '';
        this.resourceArn = cdk.Stack.of(this).formatArn({
            service: 'rds',
            resource: 'cluster',
            resourceName: auroraCluster.clusterIdentifier,
            arnFormat: cdk.ArnFormat.COLON_RESOURCE_NAME,
        });
        auroraCluster.addRotationSingleUser();
        this.auroraSecurityGroup.addIngressRule(lambdaSecurityGroup, ec2.Port.tcp(5432), 'Allow PostgreSQL access from Lambda security group');
        // Add Data API access to the Aurora cluster
        const cfnDbCluster = auroraCluster.node.defaultChild;
        cfnDbCluster.addOverride('Properties.EnableHttpEndpoint', true);
        this.auroraPgCRPolicy = new iam.ManagedPolicy(this, 'AuroraPgPolicy', {
            managedPolicyName: (0, utils_1.generatePhysicalNameV2)(this, 'AuroraPgPolicy', { maxLength: 32, lower: true }),
            statements: [
                new iam.PolicyStatement({
                    actions: [
                        'ec2:DescribeInstances',
                        'ec2:CreateNetworkInterface',
                        'ec2:AttachNetworkInterface',
                        'ec2:DescribeNetworkInterfaces',
                        'autoscaling:CompleteLifecycleAction',
                        'ec2:DeleteNetworkInterface',
                    ],
                    resources: ['*'],
                }),
                new iam.PolicyStatement({
                    actions: [
                        'rds-data:BatchExecuteStatement',
                        'rds-data:BeginTransaction',
                        'rds-data:CommitTransaction',
                        'rds-data:ExecuteStatement',
                        'rds-data:RollbackTransaction',
                    ],
                    resources: [
                        cdk.Stack.of(this).formatArn({
                            service: 'rds',
                            resource: 'cluster',
                            resourceName: `${auroraCluster.clusterIdentifier}`,
                        }),
                    ],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(this.auroraPgCRPolicy, [
            {
                id: 'AwsSolutions-IAM4',
                reason: 'The AWSLambdaBasicExecutionRole managed policy is required for ' +
                    'the Lambda function to write logs to CloudWatch.',
            },
            {
                id: 'AwsSolutions-IAM5',
                reason: 'This policy is required to allow the custom resource to create a ' +
                    'network interface for the Aurora cluster and it has to be wildcard.',
            },
        ], true);
        cdk_nag_1.NagSuppressions.addResourceSuppressions(auroraCluster, [
            {
                id: 'AwsSolutions-RDS10',
                reason: 'Deletion protection is disabled to make sure a customer can stop ' +
                    'incurring charges if they want to delete the construct.',
            },
        ], true);
        const customResource = (0, custom_resource_provider_helper_1.buildCustomResourceProvider)({
            providerName: 'AmazonAuroraPgVectorCRProvider',
            vpc: this.vpc,
            securityGroup: lambdaSecurityGroup,
            codePath: path.join(__dirname, '../../../lambda/amazon-aurora-pgvector-custom-resources'),
            handler: 'custom_resources.on_event',
            runtime: cdk.aws_lambda.Runtime.PYTHON_3_12,
        });
        const crProvider = customResource.getProvider(this);
        crProvider.role.addManagedPolicy(this.auroraPgCRPolicy);
        auroraCluster.secret?.grantRead(crProvider.role);
        const auroraPgVector = new cdk.CustomResource(this, 'AuroraPgVector', {
            resourceType: 'Custom::AmazonAuroraPgVector',
            serviceToken: crProvider.serviceToken,
            properties: {
                DatabaseName: this.databaseName,
                SecretName: auroraCluster.secret?.secretName || '',
                VectorDimensions: props.embeddingsModelVectorDimension,
            },
        });
        auroraPgVector.node.addDependency(this.auroraPgCRPolicy);
        this.auroraPgCRPolicy.node.addDependency(auroraCluster);
    }
}
exports.AmazonAuroraDefaultVectorStore = AmazonAuroraDefaultVectorStore;
_a = JSII_RTTI_SYMBOL_1;
AmazonAuroraDefaultVectorStore[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.amazonaurora.AmazonAuroraDefaultVectorStore", version: "0.1.264" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVyb3JhLWRlZmF1bHQtdmVjdG9yLXN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2Nkay1saWIvYW1hem9uYXVyb3JhL2F1cm9yYS1kZWZhdWx0LXZlY3Rvci1zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7Ozs7Ozs7OztHQVdHO0FBRUgsNkJBQTZCO0FBQzdCLG1DQUFtQztBQUNuQywyQ0FBMkM7QUFDM0MsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyxxQ0FBMEM7QUFFMUMsMEdBQW1HO0FBQ25HLHNEQUFvRTtBQUNwRSxnRUFBNEU7QUEyQjVFOzs7Ozs7Ozs7Ozs7Ozs7SUFlSTtBQUNKLE1BQWEsOEJBQStCLFNBQVEsR0FBRyxDQUFDLFFBQVE7SUFvRDlELFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEtBQTBDO1FBRTFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsSUFBSSxDQUFDLFlBQVksR0FBRyxtQkFBbUIsQ0FBQztRQUN4QyxJQUFJLENBQUMsU0FBUyxHQUFHLGdDQUFnQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzVCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxrQ0FBa0MsQ0FBQztRQUM1RCxJQUFJLENBQUMsOEJBQThCLEdBQUcsS0FBSyxDQUFDLDhCQUE4QixDQUFDO1FBRTNFLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBQSxxQkFBUSxFQUFDLElBQUksRUFBRTtZQUN4QixlQUFlLEVBQUUsSUFBQSw0QkFBZSxHQUFFO1lBQ2xDLFdBQVcsRUFBRSxLQUFLLENBQUMsR0FBRztTQUN2QixDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUU7WUFDaEMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxnQkFBZ0IsRUFBRTtTQUN2RCxDQUFDLENBQUM7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bi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyByZHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXJkcyc7XG5pbXBvcnQgeyBOYWdTdXBwcmVzc2lvbnMgfSBmcm9tICdjZGstbmFnJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgYnVpbGRDdXN0b21SZXNvdXJjZVByb3ZpZGVyIH0gZnJvbSAnLi4vLi4vY29tbW9uL2hlbHBlcnMvY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyLWhlbHBlcic7XG5pbXBvcnQgeyBnZW5lcmF0ZVBoeXNpY2FsTmFtZVYyIH0gZnJvbSAnLi4vLi4vY29tbW9uL2hlbHBlcnMvdXRpbHMnO1xuaW1wb3J0IHsgYnVpbGRWcGMsIERlZmF1bHRWcGNQcm9wcyB9IGZyb20gJy4uLy4uL2NvbW1vbi9oZWxwZXJzL3ZwYy1oZWxwZXInO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgQW1hem9uQXVyb3JhRGVmYXVsdFZlY3RvclN0b3JlUHJvcHMge1xuICAvKipcbiAgICogVGhlIGVtYmVkZGluZ3MgbW9kZWwgdmVjdG9yIGRpbWVuc2lvbiBmb3IgdGhlIGtub3dsZWRnZSBiYXNlLlxuICAgKiBNdXN0IGJlIGlkZW50aWNhbCBhcyBpbiB0aGUgS25vd2xlZGdlQmFzZSBjb25zdHJ1Y3QuXG4gICAqIFRoaXMgaXMgZHVlIHRvIHRoZSBmYWN0b3IgdGhhdCB0aGUgZW1iZWRkaW5ncyBtb2RlbHNcbiAgICogaGF2ZSBkaWZmZXJlbnQgdmVjdG9yIGRpbWVuc2lvbnMgYW5kIHRoaXMgY29uc3RydWN0XG4gICAqIG5lZWRzIHRvIGtub3cgdGhlIHZlY3RvciBkaW1lbnNpb25zIHRvIGNyZWF0ZSB0aGUgdmVjdG9yXG4gICAqIGluZGV4IG9mIGFwcHJvcHJpYXRlIGRpbWVuc2lvbnMgaW4gdGhlIEF1cm9yYSBkYXRhYmFzZS5cbiAgICovXG4gIHJlYWRvbmx5IGVtYmVkZGluZ3NNb2RlbFZlY3RvckRpbWVuc2lvbjogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgVlBDIHdoZXJlIHRoZSBBdXJvcmEgVmVjdG9yIFN0b3JlIHdpbGwgYmUgZGVwbG95ZWQgaW4uXG4gICAqIFRoZSBwcm92aWRlZCBWUEMgbXVzdCBoYXZlIGF0IGxlYXN0IG9uZSBzdWJuZXQgb2YgdHlwZVxuICAgKiBgZWMyLlN1Ym5ldFR5cGUuUFVCTElDYCBhbmQgYXQgbGVhc3Qgb25lIHN1Ym5ldCBvZiB0eXBlXG4gICAqIGBlYzIuU3VibmV0VHlwZS5QUklWQVRFX1dJVEhfRUdSRVNTYC4gSWYgbm8gc3VibmV0cyBvZiB0aGVzZVxuICAgKiB0eXBlcyBhcmUgYXZhaWxhYmxlLCB0aGUgZGVwbG95bWVudCB3aWxsIGZhaWwuXG4gICAqIElmIG5vdCBwcm92aWRlZCwgYSBuZXcgVlBDIHdpdGggdGhlIHJlcXVpcmVkIHN1Ym5ldFxuICAgKiBjb25maWd1cmF0aW9uIHdpbGwgYmUgY3JlYXRlZCBhdXRvbWF0aWNhbGx5LlxuICAgKiBAZGVmYXVsdCAtIFwiQSBuZXcgVlBDIHdpbGwgYmUgY3JlYXRlZC5cIlxuICAgKi9cbiAgcmVhZG9ubHkgdnBjPzogZWMyLklWcGM7XG59XG5cbi8qKlxuICAqIENyZWF0ZXMgZGVmYXVsdCBBbWF6b25BdXJvcmFWZWN0b3JTdG9yZS5cbiAgKlxuICAqIEl0IGluY2x1ZGVzIGNyZWF0aW9uIG9mIGEgVlBDIHdpdGggMyBzdWJuZXRzIChwdWJsaWMsXG4gICogcHJpdmF0ZSB3aXRoIE5BVCBHYXRld2F5LCBwcml2YXRlIHdpdGhvdXQgTkFUIEdhdGV3YXkpLFxuICAqIHdpdGggdGhlIEFtYXpvbiBBdXJvcmEgU2VydmVybGVzcyBWMiBDbHVzdGVyLlxuICAqIFRoZSBjbHVzdGVyIGhhcyAxIHdyaXRlci9yZWFkZXIgb2YgUG9zdGdyZVNRTCB2ZXJzaW9uIDE1LjVcbiAgKiBpbnN0YW5jZSAobWluIGNhcGFjaXR5IDAuNSwgbWF4IGNhcGFjaXR5IDQpLiBMYW1iZGEgY3VzdG9tXG4gICogcmVzb3VyY2UgZXhlY3V0ZXMgcmVxdWlyZWQgcGd2ZWN0b3IgYW5kIEFtYXpvbiBCZWRyb2NrIEtub3dsZWRnZVxuICAqIEJhc2UgU1FMIHF1ZXJpZXMgYWdhaW5zdCBBdXJvcmEgY2x1c3RlclxuICAqIGR1cmluZyBkZXBsb3ltZW50LiBUaGUgc2VjcmV0IGNvbnRhaW5pbmcgZGF0YWJhc2VzIGNyZWRlbnRpYWxzIGlzXG4gICogYmVpbmcgZGVwbG95ZWQgYW5kIHNlY3VyZWx5IHN0b3JlZCBpbiBBV1MgU2VjcmV0cyBNYW5hZ2VyLlxuICAqIFlvdSBtdXN0IHNwZWNpZnkgdGhlIHNhbWUgZW1iZWRkaW5ncyBtb2RlbCB0aGF0IHlvdSB1c2VkIGluXG4gICogS25vd2xlZGdlQmFzZSBjb25zdHJ1Y3QuXG4gICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uUkRTL2xhdGVzdC9BdXJvcmFVc2VyR3VpZGUvQXVyb3JhUG9zdGdyZVNRTC5WZWN0b3JEQi5odG1sKVxuICAqL1xuZXhwb3J0IGNsYXNzIEFtYXpvbkF1cm9yYURlZmF1bHRWZWN0b3JTdG9yZSBleHRlbmRzIGNkay5SZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHlvdXIgQW1hem9uIEF1cm9yYSBEQiBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHJlc291cmNlQXJuOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHlvdXIgRGF0YWJhc2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZGF0YWJhc2VOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBUYWJsZSBOYW1lIG9mIHlvdXIgQW1hem9uIEF1cm9yYSBEQiBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHRhYmxlTmFtZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgU2VjcmV0IEFSTiBvZiB5b3VyIEFtYXpvbiBBdXJvcmEgREIgY2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBjcmVkZW50aWFsc1NlY3JldEFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBQcmltYXJ5IGtleSBvZiB5b3VyIEFtYXpvbiBBdXJvcmEgREIgY2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBwcmltYXJ5S2V5RmllbGQ6IHN0cmluZztcblxuICAvKipcbiAgICogQ2x1c3RlciBpZGVudGlmaWVyIG9mIHlvdXIgQW1hem9uIEF1cm9yYSBEQiBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNsdXN0ZXJJZGVudGlmaWVyOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIE1vZGVsIHVzZWQgZm9yIGVtYmVkZGluZ3MuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZW1iZWRkaW5nc01vZGVsVmVjdG9yRGltZW5zaW9uOiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBWUEMgd2hlcmUgdGhlIEF1cm9yYSBEQiBDbHVzdGVyIGlzIGRlcGxveWVkLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHZwYzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIFRoZSBTZWN1cml0eSBHcm91cCBhdHRhY2hlZCB0byB0aGUgQXVyb3JhIERCIEluc3RhbmNlcyBpbiB0aGUgQ2x1c3Rlci5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBhdXJvcmFTZWN1cml0eUdyb3VwOiBlYzIuSVNlY3VyaXR5R3JvdXA7XG5cbiAgLyoqXG4gICAqIEFuIElBTSBwb2xpY3kgdGhhdCBhbGxvd3MgRGF0YSBBUEkgYWNjZXNzIHRvIEF1cm9yYS5cbiAgICogQHByaXZhdGVcbiAgICovXG4gIHByaXZhdGUgYXVyb3JhUGdDUlBvbGljeTogaWFtLk1hbmFnZWRQb2xpY3k7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgc2NvcGU6IENvbnN0cnVjdCxcbiAgICBpZDogc3RyaW5nLFxuICAgIHByb3BzOiBBbWF6b25BdXJvcmFEZWZhdWx0VmVjdG9yU3RvcmVQcm9wcyxcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMuZGF0YWJhc2VOYW1lID0gJ2JlZHJvY2tfdmVjdG9yX2RiJztcbiAgICB0aGlzLnRhYmxlTmFtZSA9ICdiZWRyb2NrX2ludGVncmF0aW9uLmJlZHJvY2tfa2InO1xuICAgIHRoaXMucHJpbWFyeUtleUZpZWxkID0gJ2lkJztcbiAgICB0aGlzLmNsdXN0ZXJJZGVudGlmaWVyID0gJ2F1cm9yYS1zZXJ2ZXJsZXNzLXZlY3Rvci1jbHVzdGVyJztcbiAgICB0aGlzLmVtYmVkZGluZ3NNb2RlbFZlY3RvckRpbWVuc2lvbiA9IHByb3BzLmVtYmVkZGluZ3NNb2RlbFZlY3RvckRpbWVuc2lvbjtcblxuICAgIHRoaXMudnBjID0gYnVpbGRWcGModGhpcywge1xuICAgICAgZGVmYXVsdFZwY1Byb3BzOiBEZWZhdWx0VnBjUHJvcHMoKSxcbiAgICAgIGV4aXN0aW5nVnBjOiBwcm9wcy52cGMsXG4gICAgfSk7XG4gICAgdGhpcy52cGMuYWRkRmxvd0xvZygnVnBjRmxvd0xvZycsIHtcbiAgICAgIGRlc3RpbmF0aW9uOiBlYzIuRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvQ2xvdWRXYXRjaExvZ3MoKSxcbiAgICB9KTtcblxuICAgIHRoaXMuYXVyb3JhU2VjdXJpdHlHcm91cCA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cCh0aGlzLCAnQXVyb3JhU2VjdXJpdHlHcm91cCcsIHtcbiAgICAgIHZwYzogdGhpcy52cGMsXG4gICAgICBzZWN1cml0eUdyb3VwTmFtZTogJ2F1cm9yYS1zZWN1cml0eS1ncm91cCcsXG4gICAgICBkZXNjcmlwdGlvbjogJ1NlY3VyaXR5IGdyb3VwIGZvciBhY2Nlc3MgdG8gQXVyb3JhIGZyb20gTGFtYmRhJyxcbiAgICB9KTtcblxuICAgIGNvbnN0IGxhbWJkYVNlY3VyaXR5R3JvdXAgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAodGhpcywgJ0xhbWJkYVNlY3VyaXR5R3JvdXAnLCB7XG4gICAgICB2cGM6IHRoaXMudnBjLFxuICAgICAgc2VjdXJpdHlHcm91cE5hbWU6ICdsYW1iZGEtc2VjdXJpdHktZ3JvdXAnLFxuICAgICAgZGVzY3JpcHRpb246ICdTZWN1cml0eSBncm91cCBmb3IgTGFtYmRhIGFjY2VzcyB0byBBdXJvcmEnLFxuICAgIH0pO1xuXG4gICAgY29uc3QgYXVyb3JhQ2x1c3RlciA9IG5ldyByZHMuRGF0YWJhc2VDbHVzdGVyKHRoaXMsICdBdXJvcmFDbHVzdGVyJywge1xuICAgICAgZW5naW5lOiByZHMuRGF0YWJhc2VDbHVzdGVyRW5naW5lLmF1cm9yYVBvc3RncmVzKHtcbiAgICAgICAgdmVyc2lvbjogcmRzLkF1cm9yYVBvc3RncmVzRW5naW5lVmVyc2lvbi5WRVJfMTVfNSxcbiAgICAgIH0pLFxuICAgICAgY3JlZGVudGlhbHM6IHJkcy5DcmVkZW50aWFscy5mcm9tR2VuZXJhdGVkU2VjcmV0KCdwb3N0Z3JlcycpLFxuICAgICAgY2x1c3RlcklkZW50aWZpZXI6IHRoaXMuY2x1c3RlcklkZW50aWZpZXIsXG4gICAgICBkZWZhdWx0RGF0YWJhc2VOYW1lOiB0aGlzLmRhdGFiYXNlTmFtZSxcbiAgICAgIHZwYzogdGhpcy52cGMsXG4gICAgICB2cGNTdWJuZXRzOiB7IHN1Ym5ldFR5cGU6IGVjMi5TdWJuZXRUeXBlLlBVQkxJQyB9LFxuICAgICAgc2VjdXJpdHlHcm91cHM6IFt0aGlzLmF1cm9yYVNlY3VyaXR5R3JvdXBdLFxuICAgICAgaWFtQXV0aGVudGljYXRpb246IHRydWUsXG4gICAgICBzdG9yYWdlRW5jcnlwdGVkOiB0cnVlLFxuICAgICAgc2VydmVybGVzc1YyTWluQ2FwYWNpdHk6IDAuNSxcbiAgICAgIHNlcnZlcmxlc3NWMk1heENhcGFjaXR5OiA0LFxuICAgICAgd3JpdGVyOiByZHMuQ2x1c3Rlckluc3RhbmNlLnNlcnZlcmxlc3NWMignQXVyb3JhU2VydmVybGVzc1dyaXRlcicpLFxuICAgICAgcmVhZGVyczogW3Jkcy5DbHVzdGVySW5zdGFuY2Uuc2VydmVybGVzc1YyKCdBdXJvcmFTZXJ2ZXJsZXNzUmVhZGVyJyxcbiAgICAgICAgeyBzY2FsZVdpdGhXcml0ZXI6IHRydWUgfSldLFxuICAgICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9KTtcbiAgICB0aGlzLmNyZWRlbnRpYWxzU2VjcmV0QXJuID0gYXVyb3JhQ2x1c3Rlci5zZWNyZXQ/LnNlY3JldEFybiB8fCAnJztcbiAgICB0aGlzLnJlc291cmNlQXJuID0gY2RrLlN0YWNrLm9mKHRoaXMpLmZvcm1hdEFybih7XG4gICAgICBzZXJ2aWNlOiAncmRzJyxcbiAgICAgIHJlc291cmNlOiAnY2x1c3RlcicsXG4gICAgICByZXNvdXJjZU5hbWU6IGF1cm9yYUNsdXN0ZXIuY2x1c3RlcklkZW50aWZpZXIsXG4gICAgICBhcm5Gb3JtYXQ6IGNkay5Bcm5Gb3JtYXQuQ09MT05fUkVTT1VSQ0VfTkFNRSxcbiAgICB9KTtcblxuICAgIGF1cm9yYUNsdXN0ZXIuYWRkUm90YXRpb25TaW5nbGVVc2VyKCk7XG5cbiAgICB0aGlzLmF1cm9yYVNlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUoXG4gICAgICBsYW1iZGFTZWN1cml0eUdyb3VwLFxuICAgICAgZWMyLlBvcnQudGNwKDU0MzIpLFxuICAgICAgJ0FsbG93IFBvc3RncmVTUUwgYWNjZXNzIGZyb20gTGFtYmRhIHNlY3VyaXR5IGdyb3VwJyxcbiAgICApO1xuXG4gICAgLy8gQWRkIERhdGEgQVBJIGFjY2VzcyB0byB0aGUgQXVyb3JhIGNsdXN0ZXJcbiAgICBjb25zdCBjZm5EYkNsdXN0ZXIgPSBhdXJvcmFDbHVzdGVyLm5vZGUuZGVmYXVsdENoaWxkIGFzIHJkcy5DZm5EQkNsdXN0ZXI7XG4gICAgY2ZuRGJDbHVzdGVyLmFkZE92ZXJyaWRlKCdQcm9wZXJ0aWVzLkVuYWJsZUh0dHBFbmRwb2ludCcsIHRydWUpO1xuXG4gICAgdGhpcy5hdXJvcmFQZ0NSUG9saWN5ID0gbmV3IGlhbS5NYW5hZ2VkUG9saWN5KHRoaXMsICdBdXJvcmFQZ1BvbGljeScsIHtcbiAgICAgIG1hbmFnZWRQb2xpY3lOYW1lOiBnZW5lcmF0ZVBoeXNpY2FsTmFtZVYyKHRoaXMsXG4gICAgICAgICdBdXJvcmFQZ1BvbGljeScsXG4gICAgICAgIHsgbWF4TGVuZ3RoOiAzMiwgbG93ZXI6IHRydWUgfSksXG4gICAgICBzdGF0ZW1lbnRzOiBbXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAnZWMyOkRlc2NyaWJlSW5zdGFuY2VzJyxcbiAgICAgICAgICAgICdlYzI6Q3JlYXRlTmV0d29ya0ludGVyZmFjZScsXG4gICAgICAgICAgICAnZWMyOkF0dGFjaE5ldHdvcmtJbnRlcmZhY2UnLFxuICAgICAgICAgICAgJ2VjMjpEZXNjcmliZU5ldHdvcmtJbnRlcmZhY2VzJyxcbiAgICAgICAgICAgICdhdXRvc2NhbGluZzpDb21wbGV0ZUxpZmVjeWNsZUFjdGlvbicsXG4gICAgICAgICAgICAnZWMyOkRlbGV0ZU5ldHdvcmtJbnRlcmZhY2UnLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgfSksXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAncmRzLWRhdGE6QmF0Y2hFeGVjdXRlU3RhdGVtZW50JyxcbiAgICAgICAgICAgICdyZHMtZGF0YTpCZWdpblRyYW5zYWN0aW9uJyxcbiAgICAgICAgICAgICdyZHMtZGF0YTpDb21taXRUcmFuc2FjdGlvbicsXG4gICAgICAgICAgICAncmRzLWRhdGE6RXhlY3V0ZVN0YXRlbWVudCcsXG4gICAgICAgICAgICAncmRzLWRhdGE6Um9sbGJhY2tUcmFuc2FjdGlvbicsXG4gICAgICAgICAgXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICAgIGNkay5TdGFjay5vZih0aGlzKS5mb3JtYXRBcm4oe1xuICAgICAgICAgICAgICBzZXJ2aWNlOiAncmRzJyxcbiAgICAgICAgICAgICAgcmVzb3VyY2U6ICdjbHVzdGVyJyxcbiAgICAgICAgICAgICAgcmVzb3VyY2VOYW1lOiBgJHthdXJvcmFDbHVzdGVyLmNsdXN0ZXJJZGVudGlmaWVyfWAsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICBdLFxuICAgICAgICB9KSxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMoXG4gICAgICB0aGlzLmF1cm9yYVBnQ1JQb2xpY3ksXG4gICAgICBbXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogJ0F3c1NvbHV0aW9ucy1JQU00JyxcbiAgICAgICAgICByZWFzb246ICdUaGUgQVdTTGFtYmRhQmFzaWNFeGVjdXRpb25Sb2xlIG1hbmFnZWQgcG9saWN5IGlzIHJlcXVpcmVkIGZvciAnICtcbiAgICAgICAgICAgICd0aGUgTGFtYmRhIGZ1bmN0aW9uIHRvIHdyaXRlIGxvZ3MgdG8gQ2xvdWRXYXRjaC4nLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtSUFNNScsXG4gICAgICAgICAgcmVhc29uOiAnVGhpcyBwb2xpY3kgaXMgcmVxdWlyZWQgdG8gYWxsb3cgdGhlIGN1c3RvbSByZXNvdXJjZSB0byBjcmVhdGUgYSAnICtcbiAgICAgICAgICAgICduZXR3b3JrIGludGVyZmFjZSBmb3IgdGhlIEF1cm9yYSBjbHVzdGVyIGFuZCBpdCBoYXMgdG8gYmUgd2lsZGNhcmQuJyxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICB0cnVlLFxuICAgICk7XG5cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMoXG4gICAgICBhdXJvcmFDbHVzdGVyLFxuICAgICAgW1xuICAgICAgICB7XG4gICAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtUkRTMTAnLFxuICAgICAgICAgIHJlYXNvbjogJ0RlbGV0aW9uIHByb3RlY3Rpb24gaXMgZGlzYWJsZWQgdG8gbWFrZSBzdXJlIGEgY3VzdG9tZXIgY2FuIHN0b3AgJyArXG4gICAgICAgICAgICAnaW5jdXJyaW5nIGNoYXJnZXMgaWYgdGhleSB3YW50IHRvIGRlbGV0ZSB0aGUgY29uc3RydWN0LicsXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgICAgdHJ1ZSxcbiAgICApO1xuXG4gICAgY29uc3QgY3VzdG9tUmVzb3VyY2UgPSBidWlsZEN1c3RvbVJlc291cmNlUHJvdmlkZXIoe1xuICAgICAgcHJvdmlkZXJOYW1lOiAnQW1hem9uQXVyb3JhUGdWZWN0b3JDUlByb3ZpZGVyJyxcbiAgICAgIHZwYzogdGhpcy52cGMsXG4gICAgICBzZWN1cml0eUdyb3VwOiBsYW1iZGFTZWN1cml0eUdyb3VwLFxuICAgICAgY29kZVBhdGg6IHBhdGguam9pbihcbiAgICAgICAgX19kaXJuYW1lLCAnLi4vLi4vLi4vbGFtYmRhL2FtYXpvbi1hdXJvcmEtcGd2ZWN0b3ItY3VzdG9tLXJlc291cmNlcycpLFxuICAgICAgaGFuZGxlcjogJ2N1c3RvbV9yZXNvdXJjZXMub25fZXZlbnQnLFxuICAgICAgcnVudGltZTogY2RrLmF3c19sYW1iZGEuUnVudGltZS5QWVRIT05fM18xMixcbiAgICB9KTtcblxuICAgIGNvbnN0IGNyUHJvdmlkZXIgPSBjdXN0b21SZXNvdXJjZS5nZXRQcm92aWRlcih0aGlzKTtcbiAgICBjclByb3ZpZGVyLnJvbGUuYWRkTWFuYWdlZFBvbGljeSh0aGlzLmF1cm9yYVBnQ1JQb2xpY3kpO1xuICAgIGF1cm9yYUNsdXN0ZXIuc2VjcmV0Py5ncmFudFJlYWQoY3JQcm92aWRlci5yb2xlKTtcblxuICAgIGNvbnN0IGF1cm9yYVBnVmVjdG9yID0gbmV3IGNkay5DdXN0b21SZXNvdXJjZSh0aGlzLCAnQXVyb3JhUGdWZWN0b3InLCB7XG4gICAgICByZXNvdXJjZVR5cGU6ICdDdXN0b206OkFtYXpvbkF1cm9yYVBnVmVjdG9yJyxcbiAgICAgIHNlcnZpY2VUb2tlbjogY3JQcm92aWRlci5zZXJ2aWNlVG9rZW4sXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIERhdGFiYXNlTmFtZTogdGhpcy5kYXRhYmFzZU5hbWUsXG4gICAgICAgIFNlY3JldE5hbWU6IGF1cm9yYUNsdXN0ZXIuc2VjcmV0Py5zZWNyZXROYW1lIHx8ICcnLFxuICAgICAgICBWZWN0b3JEaW1lbnNpb25zOiBwcm9wcy5lbWJlZGRpbmdzTW9kZWxWZWN0b3JEaW1lbnNpb24hLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGF1cm9yYVBnVmVjdG9yLm5vZGUuYWRkRGVwZW5kZW5jeSh0aGlzLmF1cm9yYVBnQ1JQb2xpY3kpO1xuICAgIHRoaXMuYXVyb3JhUGdDUlBvbGljeS5ub2RlLmFkZERlcGVuZGVuY3koYXVyb3JhQ2x1c3Rlcik7XG4gIH1cbn1cbiJdfQ==